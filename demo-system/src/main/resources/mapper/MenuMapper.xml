<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.system.menu.mapper.MenuMapper">

    <!-- ======================== SQL 공통 컬럼 ======================== -->
    <sql id="menuColumns">
        menu_id,
        menu_name,
        menu_url,
        parent_id,
        menu_order,
        menu_depth,
        icon,
        use_yn,
        description,
        created_at,
        updated_at
    </sql>

    <!-- ======================== SELECT ======================== -->

    <!-- 전체 flat 조회 → Java에서 트리 조립 -->
    <select id="selectAllMenus" resultType="Menu">
        SELECT
              <include refid="menuColumns"/>
         FROM tbl_menu
        WHERE use_yn = 'Y'
     ORDER BY menu_depth, parent_id, menu_order
    </select>

    <!-- MySQL 8.0+ WITH RECURSIVE 트리 조회 -->
    <select id="selectMenuTree" resultType="MenuTreeResponse">
        WITH RECURSIVE menu_cte AS (
            SELECT
                <include refid="menuColumns"/>,
                CAST(LPAD(menu_order, 5, '0') AS CHAR(1000)) AS sort_path
            FROM tbl_menu
            WHERE parent_id IS NULL
              AND use_yn = 'Y'

            UNION ALL

            SELECT
                m.menu_id,
                m.menu_name,
                m.menu_url,
                m.parent_id,
                m.menu_order,
                m.menu_depth,
                m.icon,
                m.use_yn,
                m.description,
                m.created_at,
                m.updated_at,
                CONCAT(mc.sort_path, '-', LPAD(m.menu_order, 5, '0'))
            FROM tbl_menu m
                INNER JOIN menu_cte mc ON m.parent_id = mc.menu_id
            WHERE m.use_yn = 'Y'
        )
        SELECT
            <include refid="menuColumns"/>
        FROM menu_cte
        ORDER BY sort_path
    </select>

    <!-- 특정 부모의 하위 메뉴만 조회 -->
    <select id="selectChildMenus" parameterType="Long" resultType="Menu">
        SELECT
            <include refid="menuColumns"/>
        FROM tbl_menu
        WHERE parent_id = #{parentId}
          AND use_yn = 'Y'
        ORDER BY menu_order
    </select>

    <!-- ======================== DELETE ======================== -->

    <!-- 하위 메뉴 포함 전체 삭제 (MySQL 8.0+) -->
    <delete id="deleteMenuWithChildren" parameterType="Long">
        DELETE FROM tbl_menu
        WHERE menu_id IN (
            WITH RECURSIVE menu_cte AS (
                SELECT menu_id
                FROM tbl_menu
                WHERE menu_id = #{menuId}

                UNION ALL

                SELECT m.menu_id
                FROM tbl_menu m
                    INNER JOIN menu_cte mc ON m.parent_id = mc.menu_id
            )
            SELECT menu_id FROM menu_cte
        )
    </delete>

</mapper>